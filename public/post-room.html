<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng Ph√≤ng Tr·ªç - PhongTro.VN</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .post-room-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .post-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
        }
        
        .post-header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .post-header p {
            opacity: 0.9;
            font-size: 18px;
        }
        
        .post-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 22px;
        }
        
        .section-title i {
            color: #3498db;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .price-input {
            position: relative;
        }
        
        .price-input input {
            padding-left: 40px;
        }
        
        .price-input::before {
            content: "ƒë";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: bold;
        }
        
        .area-input {
            position: relative;
        }
        
        .area-input input {
            padding-right: 40px;
        }
        
        .area-input::after {
            content: "m¬≤";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .checkbox-item:hover {
            background: #e9ecef;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
        }
        
        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .image-upload:hover {
            border-color: #3498db;
        }
        
        .image-upload i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .preview-item {
            position: relative;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .submit-section {
            text-align: center;
            padding-top: 30px;
        }
        
        .btn-post {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .btn-post:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }
        
        .form-note {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .form-note i {
            color: #3498db;
            margin-right: 5px;
        }
        
        .login-required {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .login-required i {
            font-size: 72px;
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        
        .login-required h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <i class="fas fa-home"></i>
                    <span>PhongTro.VN</span>
                </div>
                <div class="nav-links">
                    <a href="index.html"><i class="fas fa-home"></i> Trang Ch·ªß</a>
                    <a href="rooms.html"><i class="fas fa-search"></i> T√¨m Ph√≤ng</a>
                    <a href="post-room.html" class="active"><i class="fas fa-plus-circle"></i> ƒêƒÉng Ph√≤ng</a>
                    <a href="login.html" id="loginBtn"><i class="fas fa-user"></i> ƒêƒÉng Nh·∫≠p</a>
                    <a href="register.html" id="registerBtn"><i class="fas fa-user-plus"></i> ƒêƒÉng K√Ω</a>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName"></span>
                    <button onclick="logout()" class="btn-logout">ƒêƒÉng Xu·∫•t</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="post-room-container" id="mainContent">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load ƒë·ªông d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p -->
    </main>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let currentUser = null;
        let uploadedImages = [];
        
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        function checkLogin() {
            const user = JSON.parse(localStorage.getItem('user'));
            currentUser = user;
            
            if (user) {
                // ƒê√£ ƒëƒÉng nh·∫≠p
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = user.username;
                
                // Ki·ªÉm tra role
                if (user.role === 'chutro' || user.role === 'admin') {
                    loadPostForm();
                } else {
                    loadNotAuthorized();
                }
            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p
                loadLoginRequired();
            }
        }
        
        // Load form ƒëƒÉng ph√≤ng
        function loadPostForm() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="post-header">
                    <h1><i class="fas fa-home"></i> ƒêƒÉng Ph√≤ng Tr·ªç M·ªõi</h1>
                    <p>ƒêi·ªÅn th√¥ng tin chi ti·∫øt ƒë·ªÉ ƒëƒÉng ph√≤ng c·ªßa b·∫°n l√™n h·ªá th·ªëng</p>
                </div>
                
                <form class="post-form" id="roomForm">
                    <!-- Th√¥ng tin c∆° b·∫£n -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-info-circle"></i> Th√¥ng Tin C∆° B·∫£n
                        </h2>
                        
                        <div class="form-group">
                            <label for="title"><i class="fas fa-heading"></i> Ti√™u ƒë·ªÅ ph√≤ng *</label>
                            <input type="text" id="title" name="title" required 
                                   placeholder="V√≠ d·ª•: Ph√≤ng tr·ªç ƒë·∫πp Qu·∫≠n 1, 20m¬≤, c√≥ toilet ri√™ng">
                        </div>
                        
                        <div class="form-group">
                            <label for="description"><i class="fas fa-align-left"></i> M√¥ t·∫£ chi ti·∫øt *</label>
                            <textarea id="description" name="description" rows="5" required 
                                      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ ph√≤ng tr·ªç: v·ªã tr√≠, ti·ªán nghi, ∆∞u ƒëi·ªÉm..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group price-input">
                                <label for="price"><i class="fas fa-money-bill-wave"></i> Gi√° thu√™/th√°ng *</label>
                                <input type="number" id="price" name="price" required 
                                       placeholder="3.500.000" min="100000" step="100000">
                            </div>
                            
                            <div class="form-group area-input">
                                <label for="area"><i class="fas fa-ruler-combined"></i> Di·ªán t√≠ch (m¬≤)</label>
                                <input type="number" id="area" name="area" 
                                       placeholder="20" min="5" step="0.5">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="max_people"><i class="fas fa-user-friends"></i> S·ªë ng∆∞·ªùi t·ªëi ƒëa</label>
                                <select id="max_people" name="max_people">
                                    <option value="1">1 ng∆∞·ªùi</option>
                                    <option value="2" selected>2 ng∆∞·ªùi</option>
                                    <option value="3">3 ng∆∞·ªùi</option>
                                    <option value="4">4 ng∆∞·ªùi</option>
                                    <option value="5">5+ ng∆∞·ªùi</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="status"><i class="fas fa-bullhorn"></i> T√¨nh tr·∫°ng ph√≤ng</label>
                                <select id="status" name="status">
                                    <option value="available">C√≤n tr·ªëng</option>
                                    <option value="rented">ƒê√£ cho thu√™</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ƒê·ªãa ch·ªâ -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-map-marker-alt"></i> ƒê·ªãa Ch·ªâ
                        </h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city"><i class="fas fa-city"></i> Th√†nh ph·ªë *</label>
                                <select id="city" name="city" required>
                                    <option value="">Ch·ªçn th√†nh ph·ªë</option>
                                    <option value="H·ªì Ch√≠ Minh">H·ªì Ch√≠ Minh</option>
                                    <option value="H√† N·ªôi">H√† N·ªôi</option>
                                    <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                                    <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                                    <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="district"><i class="fas fa-map"></i> Qu·∫≠n/Huy·ªán *</label>
                                <select id="district" name="district" required>
                                    <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
                                    <option value="Qu·∫≠n 1">Qu·∫≠n 1</option>
                                    <option value="Qu·∫≠n 3">Qu·∫≠n 3</option>
                                    <option value="Qu·∫≠n 5">Qu·∫≠n 5</option>
                                    <option value="Qu·∫≠n 7">Qu·∫≠n 7</option>
                                    <option value="Qu·∫≠n 10">Qu·∫≠n 10</option>
                                    <option value="Qu·∫≠n T√¢n B√¨nh">Qu·∫≠n T√¢n B√¨nh</option>
                                    <option value="Qu·∫≠n G√≤ V·∫•p">Qu·∫≠n G√≤ V·∫•p</option>
                                    <option value="Qu·∫≠n B√¨nh Th·∫°nh">Qu·∫≠n B√¨nh Th·∫°nh</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="address"><i class="fas fa-location-dot"></i> ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
                            <input type="text" id="address" name="address" required 
                                   placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£">
                        </div>
                    </div>
                    
                    <!-- Ti·ªán nghi -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-concierge-bell"></i> Ti·ªán Nghi
                        </h2>
                        
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="wifi">
                                <span>WiFi</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="aircon">
                                <span>M√°y l·∫°nh</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="fridge">
                                <span>T·ªß l·∫°nh</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="washing">
                                <span>M√°y gi·∫∑t</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="parking">
                                <span>Ch·ªó ƒë·ªÉ xe</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="security">
                                <span>An ninh 24/7</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="elevator">
                                <span>Thang m√°y</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="amenities" value="camera">
                                <span>Camera an ninh</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- H√¨nh ·∫£nh -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-images"></i> H√¨nh ·∫¢nh
                        </h2>
                        
                        <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>K√©o th·∫£ h√¨nh ·∫£nh ho·∫∑c click ƒë·ªÉ ch·ªçn</h3>
                            <p>Ch·ªçn h√¨nh ·∫£nh ph√≤ng tr·ªç (t·ªëi ƒëa 10 ·∫£nh, ƒë·ªãnh d·∫°ng JPG, PNG)</p>
                            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" 
                                   onchange="handleImageUpload(event)">
                        </div>
                        
                        <div class="image-preview" id="imagePreview">
                            <!-- Preview images s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>
                    
                    <!-- Th√¥ng tin li√™n h·ªá -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-phone"></i> Th√¥ng Tin Li√™n H·ªá
                        </h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contact_name"><i class="fas fa-user"></i> Ng∆∞·ªùi li√™n h·ªá</label>
                                <input type="text" id="contact_name" name="contact_name" 
                                       value="${currentUser.fullname || ''}" 
                                       placeholder="T√™n ng∆∞·ªùi li√™n h·ªá">
                            </div>
                            
                            <div class="form-group">
                                <label for="contact_phone"><i class="fas fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" id="contact_phone" name="contact_phone" 
                                       value="${currentUser.phone || ''}" 
                                       placeholder="S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit -->
                    <div class="submit-section">
                        <button type="submit" class="btn-post" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> ƒêƒÉng Ph√≤ng Ngay
                        </button>
                        <p class="form-note">
                            <i class="fas fa-info-circle"></i>
                            Ph√≤ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ki·ªÉm duy·ªát tr∆∞·ªõc khi hi·ªÉn th·ªã c√¥ng khai (th·ªùi gian t·ª´ 1-24 gi·ªù)
                        </p>
                    </div>
                </form>
                
                <div id="message" style="margin-top: 20px; display: none;"></div>
            `;
            
            // Th√™m event listener cho form
            setTimeout(() => {
                document.getElementById('roomForm').addEventListener('submit', handleSubmit);
            }, 100);
        }
        
        // Load trang y√™u c·∫ßu ƒëƒÉng nh·∫≠p
        function loadLoginRequired() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng ph√≤ng</h2>
                    <p>Ch·ª©c nƒÉng n√†y y√™u c·∫ßu b·∫°n ph·∫£i ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n ch·ªß tr·ªç</p>
                    <div style="margin-top: 30px;">
                        <a href="login.html" class="btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p
                        </a>
                        <a href="register.html" class="btn-secondary">
                            <i class="fas fa-user-plus"></i> ƒêƒÉng K√Ω Ch·ªß Tr·ªç
                        </a>
                    </div>
                </div>
            `;
        }
        
        // Load trang kh√¥ng c√≥ quy·ªÅn
        function loadNotAuthorized() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="login-required">
                    <i class="fas fa-user-slash"></i>
                    <h2>B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëƒÉng ph√≤ng</h2>
                    <p>T√†i kho·∫£n c·ªßa b·∫°n hi·ªán l√† <strong>${currentUser.role}</strong>. Ch·ª©c nƒÉng ƒëƒÉng ph√≤ng ch·ªâ d√†nh cho t√†i kho·∫£n Ch·ªß Tr·ªç.</p>
                    <p>Vui l√≤ng ƒëƒÉng k√Ω t√†i kho·∫£n ch·ªß tr·ªç ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.</p>
                    <div style="margin-top: 30px;">
                        <a href="index.html" class="btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-home"></i> V·ªÅ Trang Ch·ªß
                        </a>
                        <a href="register.html" class="btn-secondary">
                            <i class="fas fa-user-plus"></i> ƒêƒÉng K√Ω Ch·ªß Tr·ªç
                        </a>
                    </div>
                </div>
            `;
        }
        
        // X·ª≠ l√Ω upload h√¨nh ·∫£nh
        function handleImageUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('imagePreview');
            
            for (let i = 0; i < Math.min(files.length, 10 - uploadedImages.length); i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // T·∫°o preview item
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-image" onclick="removeImage(${uploadedImages.length})">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    preview.appendChild(previewItem);
                    
                    // L∆∞u v√†o m·∫£ng (trong th·ª±c t·∫ø s·∫Ω upload l√™n server)
                    uploadedImages.push({
                        id: uploadedImages.length,
                        name: file.name,
                        url: e.target.result,
                        file: file
                    });
                };
                
                reader.readAsDataURL(file);
            }
            
            // Reset input
            event.target.value = '';
        }
        
        // X√≥a h√¨nh ·∫£nh
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }
        
        // C·∫≠p nh·∫≠t preview
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${image.url}" alt="Preview">
                    <div class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                preview.appendChild(previewItem);
            });
        }
        
        // ==================== X·ª¨ L√ù UPLOAD ·∫¢NH TH·∫¨T ====================

// Bi·∫øn l∆∞u tr·ªØ ·∫£nh ƒë√£ upload
let uploadedImages = [];

// X·ª≠ l√Ω upload ·∫£nh
async function handleImageUpload(event) {
    const files = event.target.files;
    const preview = document.getElementById('imagePreview');
    
    // Ch·ªâ upload t·ªëi ƒëa 10 ·∫£nh
    const remainingSlots = 10 - uploadedImages.length;
    const filesToUpload = Array.from(files).slice(0, remainingSlots);
    
    if (filesToUpload.length === 0) {
        alert('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 ·∫£nh');
        return;
    }
    
    // T·∫°o FormData
    const formData = new FormData();
    filesToUpload.forEach(file => {
        formData.append('images', file);
    });
    
    // Hi·ªÉn th·ªã loading
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang upload ·∫£nh...';
    
    try {
        // G·ª≠i request upload
        const response = await fetch('http://localhost:3000/api/upload', {
            method: 'POST',
            body: formData
            // Kh√¥ng set Content-Type header, browser s·∫Ω t·ª± set v·ªõi boundary
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Th√™m ·∫£nh v√†o danh s√°ch
            result.images.forEach(imageUrl => {
                uploadedImages.push({
                    url: imageUrl,
                    filename: imageUrl.split('/').pop()
                });
            });
            
            // C·∫≠p nh·∫≠t preview
            updateImagePreview();
            
            showMessage(`‚úÖ ƒê√£ upload ${result.images.length} ·∫£nh th√†nh c√¥ng!`, 'success');
        } else {
            showMessage('‚ùå ' + result.error, 'error');
        }
    } catch (error) {
        console.error('L·ªói upload ·∫£nh:', error);
        showMessage('‚ùå L·ªói upload ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
    
    // Reset input
    event.target.value = '';
}

// X√≥a ·∫£nh
async function removeImage(index) {
    const image = uploadedImages[index];
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh n√†y?')) return;
    
    try {
        // X√≥a ·∫£nh tr√™n server
        const response = await fetch(`http://localhost:3000/api/upload/${image.filename}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // X√≥a kh·ªèi m·∫£ng
            uploadedImages.splice(index, 1);
            updateImagePreview();
            showMessage('‚úÖ ƒê√£ x√≥a ·∫£nh', 'success');
        } else {
            showMessage('‚ùå ' + result.error, 'error');
        }
    } catch (error) {
        console.error('L·ªói x√≥a ·∫£nh:', error);
        // V·∫´n x√≥a kh·ªèi preview n·∫øu l·ªói
        uploadedImages.splice(index, 1);
        updateImagePreview();
    }
}

// C·∫≠p nh·∫≠t preview
function updateImagePreview() {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (uploadedImages.length === 0) {
        preview.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                <i class="fas fa-images" style="font-size: 36px; margin-bottom: 10px;"></i>
                <p>Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c upload</p>
            </div>
        `;
        return;
    }
    
    uploadedImages.forEach((image, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        previewItem.innerHTML = `
            <img src="http://localhost:3000${image.url}" alt="Preview" 
                 onerror="this.src='https://via.placeholder.com/150/4dabf7/fff?text=·∫¢nh+l·ªói'">
            <div class="remove-image" onclick="removeImage(${index})">
                <i class="fas fa-times"></i>
            </div>
        `;
        preview.appendChild(previewItem);
    });
}

// ==================== X·ª¨ L√ù SUBMIT FORM C√ì ·∫¢NH ====================

async function handleSubmit(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showMessage('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
        return;
    }
    
    // Validate form
    const title = document.getElementById('title').value;
    const price = document.getElementById('price').value;
    const address = document.getElementById('address').value;
    const city = document.getElementById('city').value;
    const district = document.getElementById('district').value;
    
    if (!title || !price || !address || !city || !district) {
        showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin b·∫Øt bu·ªôc!', 'error');
        return;
    }
    
    // L·∫•y d·ªØ li·ªáu form
    const formData = {
        owner_id: currentUser.id,
        title: title,
        description: document.getElementById('description').value || '',
        price: parseInt(price),
        address: address,
        city: city,
        district: district,
        area: parseFloat(document.getElementById('area').value) || 0,
        max_people: parseInt(document.getElementById('max_people').value) || 1,
        image_urls: JSON.stringify(uploadedImages.map(img => img.url)) // Chuy·ªÉn th√†nh JSON string
    };
    
    console.log('üìù D·ªØ li·ªáu g·ª≠i l√™n:', formData);
    
    // V√¥ hi·ªáu h√≥a n√∫t submit
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
    
    try {
        const response = await fetch('http://localhost:3000/api/rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(
                `üéâ ƒêƒÉng ph√≤ng th√†nh c√¥ng! M√£ ph√≤ng: #${result.roomId}<br>
                 Ph√≤ng c·ªßa b·∫°n ƒëang ch·ªù duy·ªát v√† s·∫Ω hi·ªÉn th·ªã sau khi ƒë∆∞·ª£c ph√™ duy·ªát.`,
                'success'
            );
            
            // Reset form
            document.getElementById('roomForm').reset();
            uploadedImages = [];
            updateImagePreview();
            
            // T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y
            setTimeout(() => {
                window.location.href = `room-detail.html?id=${result.roomId}`;
            }, 3000);
        } else {
            showMessage('‚ùå ' + (result.error || 'ƒêƒÉng ph√≤ng th·∫•t b·∫°i!'), 'error');
            console.error('Chi ti·∫øt l·ªói:', result);
        }
    } catch (error) {
        showMessage('‚ùå L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
        console.error('Error:', error);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

        // X·ª≠ l√Ω submit form
        async function handleSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showMessage('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return;
            }
            
            // L·∫•y d·ªØ li·ªáu form
            const formData = {
                owner_id: currentUser.id,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                price: parseInt(document.getElementById('price').value),
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                area: parseFloat(document.getElementById('area').value) || 0,
                max_people: parseInt(document.getElementById('max_people').value)
            };
            
            // Validate
            if (!formData.title || !formData.description || !formData.price || 
                !formData.address || !formData.city || !formData.district) {
                showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin b·∫Øt bu·ªôc!', 'error');
                return;
            }
            
            if (formData.price < 100000) {
                showMessage('Gi√° thu√™ ph·∫£i t·ª´ 100,000 VNƒê tr·ªü l√™n!', 'error');
                return;
            }
            
            // V√¥ hi·ªáu h√≥a n√∫t submit
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            
            try {
                const response = await fetch('http://localhost:3000/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(
                        `üéâ ƒêƒÉng ph√≤ng th√†nh c√¥ng! M√£ ph√≤ng: #${result.roomId}<br>
                         Ph√≤ng c·ªßa b·∫°n ƒëang ch·ªù duy·ªát v√† s·∫Ω hi·ªÉn th·ªã sau khi ƒë∆∞·ª£c ph√™ duy·ªát.`,
                        'success'
                    );
                    
                    // Reset form
                    document.getElementById('roomForm').reset();
                    uploadedImages = [];
                    updateImagePreview();
                    
                    // T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y
                    setTimeout(() => {
                        window.location.href = `room-detail.html?id=${result.roomId}`;
                    }, 3000);
                } else {
                    showMessage('‚ùå ' + (result.error || 'ƒêƒÉng ph√≤ng th·∫•t b·∫°i!'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
                console.error('Error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(text, type) {
            let messageDiv = document.getElementById('message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'message';
                document.querySelector('.post-form').appendChild(messageDiv);
            }
            
            messageDiv.innerHTML = text;
            messageDiv.style.display = 'block';
            messageDiv.style.padding = '15px';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.marginTop = '20px';
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.style.border = '1px solid #c3e6cb';
            } else {
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.border = '1px solid #f5c6cb';
            }
        }
        
        // ƒêƒÉng xu·∫•t
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
        
        // Ch·∫°y khi trang load
        document.addEventListener('DOMContentLoaded', checkLogin);
    </script>
</body>
</html>